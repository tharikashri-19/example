<!DOCTYPE html>
<html>
<head>
<title>NATPAC Smart Travel Tracker</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{
  background:#0f2027;
  color:white;
  font-family:Arial;
  text-align:center;
}
.card{
  background:white;
  color:black;
  width:90%;
  max-width:400px;
  margin:40px auto;
  padding:20px;
  border-radius:15px;
}
.popup{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.6);
}
.popup-box{
  background:white;
  color:black;
  width:85%;
  max-width:350px;
  margin:100px auto;
  padding:20px;
  border-radius:15px;
}
button{
  padding:10px;
  margin:5px;
  border:none;
  border-radius:10px;
}
.yes{background:#2ecc71;color:white;}
.no{background:#e74c3c;color:white;}
</style>
</head>

<body onload="startMonitoring()">

<h2>üöç NATPAC Travel Tracker</h2>

<div class="card">
  <p>Latitude: <span id="lat">--</span></p>
  <p>Longitude: <span id="lon">--</span></p>
  <p>Status: <span id="status">Waiting for movement</span></p>
</div>

<div class="popup" id="popup">
  <div class="popup-box">
    <h3>Trip Detected</h3>
    <p>Detected Mode: <b id="detectedMode"></b></p>
    <p>Is this correct?</p>

    <button class="yes" onclick="confirmMode(true)">Yes</button>
    <button class="no" onclick="showManual()">No</button>

    <div id="manual" style="display:none">
      <select id="mode">
        <option>Bus</option>
        <option>Car</option>
        <option>Bike</option>
        <option>Walk</option>
      </select><br><br>

      <select id="purpose">
        <option>Work</option>
        <option>Education</option>
        <option>Shopping</option>
      </select><br><br>

      <input id="cost" type="number" placeholder="Cost ‚Çπ"><br><br>

      <button onclick="confirmMode(false)">Submit</button>
    </div>
  </div>
</div>

<script>
let watchId;
let tripActive=false;
let lat,lon;
let highSpeed=0, lowSpeed=0;
let detectedMode="";

function startMonitoring(){
  watchId = navigator.geolocation.watchPosition(pos=>{
    lat = pos.coords.latitude;
    lon = pos.coords.longitude;
    let speed = (pos.coords.speed || 0) * 3.6;

    document.getElementById("lat").innerText = lat.toFixed(5);
    document.getElementById("lon").innerText = lon.toFixed(5);

    if(speed > 3){
      highSpeed++;
      lowSpeed=0;
    } else {
      lowSpeed++;
      highSpeed=0;
    }

    if(!tripActive && highSpeed >= 10){
      tripActive = true;
      detectedMode = detectMode(speed);
      document.getElementById("status").innerText="Trip started automatically";
    }

    if(tripActive && lowSpeed >= 20){
      tripActive=false;
      navigator.geolocation.clearWatch(watchId);
      document.getElementById("detectedMode").innerText=detectedMode;
      document.getElementById("popup").style.display="block";
    }
  }, err=>alert("Location error"), {enableHighAccuracy:true});
}

function detectMode(speed){
  if(speed<=5) return "Walk";
  if(speed<=15) return "Cycle";
  if(speed<=35) return "Bike";
  return "Car / Bus";
}

function showManual(){
  document.getElementById("manual").style.display="block";
}

function confirmMode(correct){
  let mode = correct ? detectedMode : document.getElementById("mode").value;

  fetch("http://127.0.0.1:5000/saveTrip",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      latitude:lat,
      longitude:lon,
      mode:mode,
      purpose:document.getElementById("purpose")?.value || "Unknown",
      cost:document.getElementById("cost")?.value || 0
    })
  }).then(()=>{
    alert("Trip saved ‚úÖ");
    document.getElementById("popup").style.display="none";
  });
}
</script>

</body>
</html>
